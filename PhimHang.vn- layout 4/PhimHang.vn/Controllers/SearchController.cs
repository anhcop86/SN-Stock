using Microsoft.AspNet.Identity;
using Microsoft.AspNet.Identity.EntityFramework;
using PhimHang.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Web;
using System.Web.Mvc;
using System.Data.Entity;

namespace PhimHang.Controllers
{
    public class SearchController : Controller
    {
        private testEntities db = new testEntities();
        //
        // GET: /Search/
        public ActionResult Index(string q)
        {
            if (string.IsNullOrEmpty(q))
            {
                return RedirectToAction("Helper");
            }
            else
            {
                //var search = db.StockCodes.FirstOrDefault(s => s.Code.StartsWith(q.Replace("$", ""))).Code;
                var search = (from sc in db.StockCodes
                             where sc.Code.StartsWith(q.Replace("$", ""))
                             select sc.Code).FirstOrDefault();
                if (search != null)
                {
                    return RedirectToAction("/" + search, "Ticker");    
                }
                else
                {
                    return RedirectToAction("Helper");
                }
                
            }

        }
        public ActionResult Helper()
        {
            return View();
        }

        [HttpGet]
        public async Task<dynamic> GetStockPriChart(string chart)
        {
            var ret = (from sp in db.StockPrices
                       orderby sp.TradingDate
                       where sp.Code == "HAG"
                       select new
                       {
                           t = sp.TradingDate,
                           o = sp.OpenPrice,
                           h = sp.HighPrice,
                           l = sp.LowPrice,
                           c = sp.ClosePrice,
                           s = sp.Totalshare
                       }).ToList();
            //var result = Newtonsoft.Json.JsonConvert.SerializeObject(ret);
            //return result;
            return Json(ret, JsonRequestBehavior.AllowGet);
            //string ret = "[[1388682000000,20400,20700,20300,20500,1118080],[1388941200000,20600,20900,20500,20900,1191470],[1389027600000,21000,21100,20800,20800,1893680],[1389114000000,20700,20900,20700,20800,715370],[1389200400000,20800,21000,20700,20900,1453150],[1389286800000,20900,21200,20800,20800,2107880],[1389546000000,20800,20900,20600,20700,1177320],[1389632400000,20700,21600,20700,21200,3351200],[1389718800000,21300,21400,21000,21000,2107600],[1389805200000,21100,21800,21000,21800,5266020],[1389891600000,21900,22500,21800,21800,6890830],[1390150800000,21800,22500,21700,21800,4013080],[1390237200000,21800,22100,21300,22100,3303200],[1390323600000,22100,22200,21600,21700,2057310],[1390410000000,21600,21900,21500,21600,970150],[1390496400000,21800,22400,21800,22100,4252180],[1390755600000,22000,22200,21900,21900,1550070],[1391619600000,21800,22300,21800,22100,2600370],[1391706000000,22200,22800,22100,22800,5459080],[1391965200000,22800,24300,22700,24300,5720910],[1392051600000,24800,25000,23900,24000,5775570],[1392138000000,24200,24700,24000,24700,5930600],[1392224400000,24900,25300,24300,24800,7613670],[1392310800000,24800,25100,24600,24900,4039850],[1392570000000,25100,26600,25100,25900,12285240],[1392656400000,25700,26200,25600,25900,3439870],[1392742800000,26100,26500,25800,26200,4421500],[1392829200000,26100,26200,24400,25000,10647640],[1392915600000,24800,25100,24300,24800,3944310],[1393174800000,25000,25400,24900,25100,5962440],[1393261200000,25100,26200,25000,26200,5999650],[1393347600000,26500,28000,26300,28000,9961580],[1393434000000,28000,28600,27500,27500,6201580],[1393520400000,27400,27600,26800,27200,5661270],[1393779600000,27000,27100,26000,26000,6274790],[1393866000000,25600,26100,25100,25600,4425300],[1393952400000,26300,26400,26000,26200,3904320],[1394038800000,26300,27200,26300,26900,6412600],[1394125200000,27000,27000,26500,26500,5294430],[1394384400000,26500,27100,26500,26700,3461160],[1394470800000,26900,27300,26600,27000,4491500],[1394557200000,27100,27400,26800,26900,4046590],[1394643600000,26900,27000,26600,27000,4554300],[1394730000000,27200,27700,26900,27100,6236420],[1394989200000,27700,28400,27400,28200,6988470],[1395075600000,28300,28400,27800,28100,6095480],[1395162000000,28000,28500,27900,28400,4213440],[1395248400000,28600,29400,28500,29000,8277390],[1395334800000,29000,29700,29000,29500,7388590],[1395594000000,29500,29700,29200,29600,4403780],[1395680400000,29400,29600,28600,28600,7597460],[1395766800000,28800,28800,27600,27800,7075340],[1395853200000,27800,28500,27400,28400,3246690],[1395939600000,28500,28700,28000,28000,2828590],[1396198800000,28200,28500,27800,28100,2658310],[1396285200000,28400,29300,28200,28400,6526500],[1396371600000,28500,28800,27700,28200,3482590],[1396458000000,28400,28700,28300,28400,1439190],[1396544400000,28500,28900,28400,28800,3503420],[1396803600000,28900,29400,28800,28900,3408520],[1396890000000,29000,29100,28700,28700,1954010],[1397062800000,28800,29000,28500,28500,2718670],[1397149200000,28400,28500,27900,28200,4843090],[1397408400000,28200,28400,27900,27900,2517470],[1397494800000,27900,28000,27300,27400,3888710],[1397581200000,27400,27400,26400,26500,4180050],[1397667600000,26900,27200,26500,26900,4444760],[1397754000000,27000,27000,26200,26300,2928510],[1398013200000,26300,26600,25500,25500,2504730],[1398099600000,25800,26800,25400,26800,2872730],[1398186000000,26800,27000,26200,26400,1133900],[1398272400000,26200,26700,26200,26500,1284040],[1398358800000,26700,26700,26300,26400,2841620],[1398618000000,26600,26600,26000,26000,1841840],[1398704400000,25900,26200,25800,26000,1799680],[1399222800000,26200,26300,25000,25100,2434750],[1399309200000,25000,25100,24000,24600,4323980],[1399395600000,24700,24800,24000,24300,1619630],[1399482000000,23700,23700,22600,22600,6768620],[1399568400000,22100,23100,21700,22600,4260080],[1399827600000,22400,22400,21100,21100,6845440],[1399914000000,21000,21900,21000,21900,4747100],[1400000400000,21800,23400,21700,23400,3909650],[1400086800000,23400,24600,22500,23400,6690560],[1400173200000,23500,24900,23400,24700,5042650],[1400432400000,24500,24800,24100,24500,2557910],[1400518800000,24200,24700,23800,24700,3442860],[1400605200000,24800,25200,24400,25000,2750410],[1400691600000,24900,25200,24300,24300,2294040],[1400778000000,24300,24500,23900,24100,1756750],[1401037200000,23800,24100,23500,24000,1647410],[1401123600000,24000,24600,23900,24500,2448430],[1401210000000,24700,25000,24400,24600,2470540],[1401296400000,24500,24700,24100,24200,2708080],[1401382800000,24000,24300,23900,24300,1336460],[1401642000000,24300,24300,23800,24000,1642870],[1401728400000,24100,24200,23800,23900,1353630],[1401814800000,23900,24000,23300,23400,1742030],[1401901200000,23200,23600,23100,23400,1078280],[1401987600000,23600,23800,23400,23800,1898720],[1402246800000,24000,24300,23700,24000,2787650],[1402333200000,24100,24900,24000,24200,5715500],[1402419600000,24200,24700,24200,24500,1770400],[1402506000000,24600,24700,24200,24300,1974400],[1402592400000,24300,24300,24100,24200,1843160],[1402851600000,24400,24700,24200,24400,1981630],[1402938000000,24500,24600,24200,24600,2260210],[1403024400000,24600,24800,24400,24400,997580],[1403110800000,24000,24300,23600,24000,2814870],[1403197200000,24200,24300,23800,23800,4748710],[1403456400000,23800,24000,23700,23700,1565970],[1403542800000,23700,23900,23600,23900,1083790],[1403629200000,24000,24500,24000,24300,2909020],[1403715600000,24400,24800,24200,24500,4429630],[1403802000000,24500,24700,24300,24300,1154640],[1404061200000,24200,24400,24200,24200,972550],[1404147600000,24200,24700,24100,24500,2663410],[1404234000000,24500,24900,24500,24700,2319430],[1404320400000,24900,25200,24700,25000,3576340],[1404406800000,25100,25200,24900,25000,2768850],[1404666000000,25200,25800,25200,25500,4448280],[1404752400000,25500,25700,25300,25700,3232150],[1404838800000,25800,25900,25500,25600,2085600],[1404925200000,25500,25600,24900,25100,5356180],[1405011600000,25100,25200,24800,25000,1559710],[1405270800000,25200,25600,25100,25400,2013040],[1405357200000,25500,25600,25300,25300,1396190],[1405443600000,25600,26000,25300,25300,2854660],[1405530000000,25400,25500,25100,25400,1304210],[1405616400000,25400,25600,25300,25400,1972820],[1405875600000,25600,25700,25000,25400,1785750],[1405962000000,25400,26100,25300,25700,4853250],[1406048400000,25700,25800,25500,25700,917290],[1406134800000,25700,26000,25600,25800,2035890],[1406221200000,26000,26400,25900,25900,5009580],[1406480400000,25900,25900,25100,25200,2995550],[1406566800000,25200,25300,25000,25200,1476650],[1406653200000,25200,25400,25100,25300,1664880],[1406739600000,25300,25600,25300,25400,1312530],[1406826000000,25400,25600,25300,25500,1187570],[1407085200000,25400,25500,25300,25500,838490],[1407171600000,25500,25800,25400,25700,2135370],[1407258000000,25700,25700,25400,25400,2313950],[1407344400000,25400,25500,25200,25300,2105450],[1407430800000,25400,25500,25000,25100,4694820],[1407690000000,25100,25200,24800,24900,2374010],[1407776400000,24900,25200,24900,25100,1834310],[1407862800000,25100,25300,25100,25300,1069410],[1407949200000,25500,25700,25400,25600,3460410],[1408035600000,25400,25500,25100,25300,3198220],[1408294800000,25400,25700,25300,25400,3566200],[1408381200000,25500,25600,25100,25200,3118940],[1408467600000,25000,25300,25000,25200,2353160],[1408554000000,25200,25400,25100,25300,4254230],[1408640400000,25300,25600,25300,25300,3301300],[1408899600000,25500,26000,25500,26000,7137200]]";

            
        }


	}
}