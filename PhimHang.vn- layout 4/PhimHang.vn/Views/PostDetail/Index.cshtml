@{
    ViewBag.Title = "Chi tiết bài tin " + ViewBag.StockPrimary + " " + ViewBag.PostId;
    Layout = "~/Views/Shared/_Layout_Post_Detail.cshtml";
}
@section scripts{    
    <script src="~/Scripts/jquery.timeago.js"></script>
    <script src="~/ThemeBlue/js/Extention.js"></script>
}
<div id="CommentForKoLoad">
    <input type="hidden" id="hiddenPostId" value="@ViewBag.PostId" />
    <input type="hidden" id="hiddenCureentUserId" value="@ViewBag.CureentUserId" />
    <input type="hidden" id="hiddenUserName" value="@ViewBag.UserName" />
    <input type="hidden" id="hiddenAvataImageUrl" value="@ViewBag.AvataImageUrl" />
    <div class="area-center">
        <div class="bg-white open">
            <div class="list-item-status" tabindex="-1">
                <div class="avata-genaral-size">
                    <img id="idImgPostDetail" class="img-rounded" alt="avatar">
                </div>
                <div class="list-item-detail">
                    <div class="list-item-date" id="idPostedDateDetail"></div>
                    <div onclick='selectMe(event,"#")' class="list-item-username" style="width:0%">
                        <div id="idPostNameDetail"></div>
                    </div>
                    <span id="idStmDetail">                        
                        @{
                            if (ViewBag.Stm == 1)
                            {
                                <span class='divBear-cm'>Giảm</span>
                            }
                            else if (ViewBag.Stm == 2)
                            {
                                <span class='divBull-cm'>Tăng</span>
                            }                            
                        }
                    </span>
                    <div class="list-item-status-content" id="idPostMessenge">@Html.Raw(ViewBag.Message)</div>
                    <div class="list-item-control">
                        <a class="button" href="#"><i class="fa fa-comments"></i></a>                        
                        <div style="float: right; overflow: hidden; " class="fb-like" data-href="/PostDetail?postid=@ViewBag.PostId" data-layout='button_count' data-action='like' data-show-faces='true' data-share='true'></div>                        
                    </div>
                </div>
            </div>
            <div style="display: block;" class="list-comment">
                <div class="comment-item">
                    <div class="avata-genaral-size">
                        <img style="left:15px" src="@ViewBag.AvataImageUrl?width=35&height=35&mode=crop" class="img-rounded" alt="avatar">
                    </div>
                    <div id="input-comment" class="input-status">
                        <form name="frmComment">

                            <div class="input-status-text">
                                <textarea data-bind="value : newReply, valueUpdate : 'afterkeydown' , limitCharacters : 140" class="status-cm" id="comment-text" name="comment" rows="5" placeholder="Nhập trả lời ở đây" title="Search" autocomplete="off"></textarea>
                            </div>
                            <div class="status-control">
                                @{
                                    if (User.Identity.IsAuthenticated)
                                    {
                                        <div id="btnPhim" class="f-right">
                                            <span data-bind="text : countReply"></span>
                                            <button id="btAddPost" style="cursor:pointer" class="button-phim" data-bind=" enable: enablePhimHangReply , click : addReply ">Trả lời</button>
                                        </div>
                                    }
                                    else
                                    {
                                        <div id="btnPhim" class="f-right">
                                            <a class="logoutbutton" href="/Account/Register?ReturnUrl=/PostDetail?postid=@ViewBag.PostId">REGISTER</a>
                                            <a class="logoutbutton" href="/Account/Login?ReturnUrl=/PostDetail?postid=@ViewBag.PostId">LOGIN</a>
                                        </div>
                                    }
                                }
                            </div>
                        </form>
                    </div>
                </div>
                <div><!--<div class="scroll-div"> -->                    
                    <div data-bind="foreach : replys">
                        <div class="comment-item">
                            <div class="avata-genaral-size">
                                <img data-bind="attr: { src: ReplyByAvatar },click : function() {  location.href='/user/' + ReplyByName + '/tab/1' }" class="img-rounded" alt="avatar">
                            </div>
                            <div class="list-item-detail-post">
                                <div class="list-item-date" data-bind="text : ReplyDate"></div>
                                <div class="list-item-username" data-bind="text: ReplyByName"></div>
                                <div class="list-item-status-content" data-bind="html: ReplyMessage"></div>
                                <div class="list-item-control-cm">
                                    <a class="button f-right" href="#" title="Vi phạm">Vi phạm</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Comment-->

<script type="text/javascript">

    function selectMe(e, data) {        // khi nguoi dung click vao link trong knockout js click event
        e.stopPropagation();
    }

    function setDefaultAfterPost() {
        $('.divBull, .divBear').parent().children('.switch3button-select').removeClass('switch3button-select'); // remove style of all radio button
        $('input[type=radio]').prop('checked', false); // remove checked of radio button
        //$("#status").css('height', '25'); // set size default of textarea
        //$('#status').parent().next('.status-control').hide(); // set hide button
        $('.chartImage').hide();
        $('.mb3-chart-thumb').removeAttr("src");
    }
    function getTimeAgo(varDate) {
        if (varDate) {
            return $.timeago(varDate);
        }
        else {
            return '';
        }
    }
    function Reply(data) {
        var self = this;
        data = data || {};
        self.ReplyId = data.ReplyId;
        self.ReplyMessage = data.ReplyMessage || "";
        self.ReplyByName = data.ReplyByName || "";
        self.ReplyByAvatar = data.ReplyByAvatar + '?width=46&height=46&mode=crop' || "";
        self.ReplyDate = getTimeAgo(data.ReplyDate);
        self.PostCommentsId = data.PostCommentsId;
    }
    function Post(data) {
        var self = this;
        data = data || {};
        self.PostId = data.PostId;
        self.Message = data.Message || "";
        self.PostedByName = data.PostedByName || "";
        self.PostedByAvatar = data.PostedByAvatar + '?width=50&height=50&mode=crop' || "";
        self.PostedDate = getTimeAgo(data.PostedDate);
        self.StockPrimary = data.StockPrimary;
        //self.notification = ko.observable(0);
        self.Stm = (data.Stm === 1 ? "<span class='divBear-cm'>Giảm</span>" : data.Stm === 2 ? "<span class='divBull-cm'>Tăng</span>" : "") || "";
        self.ChartYN = data.ChartYN || 0;
    }
    var commenthub = $.connection.CommentHub;
    function viewModel() {
        var self = this;
        self.posts = ko.observableArray(); // danh muc post
        self.replys = ko.observableArray(); // danh mục reply
        self.postPins = ko.observableArray(); // danh muc cac bai post dc pin len dau
        self.newMessage = ko.observable('$@ViewBag.StockCode '); // noi dung tin post
        self.newReply = ko.observable(''); // noi dung tin reply
        self.error = ko.observable();
        self.newPosts = ko.observableArray(); // biến tạm để luu post moi, sau khi click thi moi bung ra
        self.postDetail = ko.observableArray();
        // SignalR related

        var checkpost = '';
        var checkreply = '';
        var postidCurrent = 0;
        var checkLoadFirst = 0;
        var filterhere = "";

        self.init = function () {
            self.error(null);
            $.ajax({
                cache: false,
                type: "GET",
                url: '@Url.Action("GetReplyByPostId", "PostDetail")',
                data: { replyid: $('#hiddenPostId').val() },
                beforeSend: function (xhr) {
                    //Add your image loader here
                },
                success: function (data) {
                    var mappedPosts = $.map(ko.utils.parseJson(data), function (item) { return new Reply(item); });
                    $(mappedPosts).each(function (index, element) {
                        self.replys.push(element);
                    });
                    // load post
                    $("#idPostedDateDetail").html(getTimeAgo('@ViewBag.PostedDate'));
                    $("#idPostNameDetail").html('@ViewBag.PostedByName');
                    $("#idImgPostDetail").attr('src', '@ViewBag.PostedByAvatar?width=50&height=50&mode=crop');
                    @*$("#idPostMessenge").html('@Html.Raw(ViewBag.Message)'); đã có ở trên*@
                    $("#idStmDetail").html(data.Stm);
                }
            });
        }        
        self.addReply = function () { // them tra loi
            commenthub.server.addReply({ "Message": self.newReply(), "PostedBy": $('#hiddenPostId').val() }, 'StockDetail', $('#hiddenCureentUserId').val(), $('#hiddenUserName').val(), $('#hiddenAvataImageUrl').val())
                .done(function () {
                    showNotification('Bạn đã trả lời thành công!');
                })
                .fail(function (err) {
                    self.error(err);
                });
            checkreply = 'Y';
            self.newReply('');
        }
        // nhan dc notification tu user khac
        commenthub.client.MessegeOfUserPost = function (number) {
            var num = $(".MessegeNofity").html();
            if (num != null) {
                $(".MessegeNofity").html(parseInt(num) + number);
            }
            else {
                $("#CreateMesseger").html("<span class='MessegeNofity'>1</span>");
            }
        }

       
        commenthub.client.addReply = function (reply) {
            self.replys.unshift(new Reply(reply));
            //self.replys.splice(0, 0, new Reply(reply));
        }

        /////////////////////

        self.loadNewPosts = function () {
            self.posts(self.newPosts().concat(self.posts()));
            self.newPosts([]);
            document.title = $('#titleHidenPage').val();
        }

        self.afterAdd = function (elem) {
            if (checkLoadFirst == 1) {
                //$(elem).hide().slideDown('slow');
                $(elem).hide().slideDown('slow')
            }
        };

        self.enablePhimHangReply = ko.computed(function () {
            return self.newReply().length <= 140 && self.newReply().length >= 6;
        });
        self.countReply = ko.computed(function () {
            var countNum = 140 - self.newReply().length;
            return countNum;
        });       
        
    }

    ko.bindingHandlers.limitCharacters = {
        update: function (element, valueAccessor, allBindingsAccessor, viewModel) {
            element.value = element.value.substr(0, valueAccessor());
            allBindingsAccessor().value(element.value.substr(0, valueAccessor()));
        }
    };
    var vmPost = new viewModel();
    ko.applyBindings(vmPost, document.getElementById("CommentForKoLoad"));
    $.connection.hub.start({ transport: ['webSockets', 'serverSentEvents', 'longPolling'] })
                            .done(function () {
                                vmPost.init();
                                $('.ajaxLoadingInit').html('');

                            }).fail(function (fail) {
                                console.log('Không thể mở kết nối đến server' + fail);
                            });

    $.connection.hub.disconnected(function () {
        setTimeout(function () {
            $.connection.hub.start().done(function () {
                commenthub.server.joinRoom('@ViewBag.StockCode');
            });
        }, 10000); // Restart connection after 10 seconds.
    });
    $.connection.hub.connectionSlow(function () {
        console.log('Kết nối đến server chậm do đường truyền')
    });
    window.onbeforeunload = function (e) {
        //$.connection.hub.stop
        //commenthub.server.stop = function () {
        //    $.connection.hub.stop();

        //    console.log('window.onbeforeunload');
        //};
    };


    //$.connection.hub.logging = true;

</script>
